//* This file is part of the MOOSE framework
//* https://www.mooseframework.org
//*
//* All rights reserved, see COPYRIGHT for full restrictions
//* https://github.com/idaholab/moose/blob/master/COPYRIGHT
//*
//* Licensed under LGPL 2.1, please see LICENSE for details
//* https://www.gnu.org/licenses/lgpl-2.1.html

#include "HCAngularQuadrature.h"

#include "MooseUtils.h"

#include "libmesh/dense_matrix.h"
#include "libmesh/dense_vector.h"

namespace HCAngularQuadrature
{

void
getLegHRQ(unsigned int order, std::vector<Real> & x, std::vector<Real> & w)
{
  // this is basically a big lookup table for pre-tabulated abscissae x and weights w
  switch (order)
  {
    case 2:
      x = {0.2113248654051872, 0.7886751345948129};
      w = {0.5, 0.5};
      break;
    case 4:
      x = {0.06943184420297366, 0.3300094782075719, 0.6699905217924281, 0.9305681557970262};
      w = {0.1739274225687273, 0.3260725774312733, 0.3260725774312729, 0.1739274225687271};
      break;
    case 6:
      x = {0.03376524289842392,
           0.1693953067668676,
           0.3806904069584015,
           0.6193095930415985,
           0.8306046932331324,
           0.9662347571015761};
      w = {0.08566224618958523,
           0.1803807865240692,
           0.2339569672863452,
           0.2339569672863455,
           0.1803807865240691,
           0.0856622461895854};
      break;
    case 8:
      x = {0.01985507175123175,
           0.1016667612931865,
           0.2372337950418355,
           0.4082826787521751,
           0.5917173212478248,
           0.7627662049581646,
           0.8983332387068135,
           0.9801449282487682};
      w = {0.050614268145188,
           0.1111905172266872,
           0.1568533229389437,
           0.1813418916891811,
           0.181341891689181,
           0.1568533229389435,
           0.1111905172266871,
           0.05061426814518794};
      break;
    case 10:
      x = {0.01304673574141424,
           0.06746831665550779,
           0.1602952158504878,
           0.2833023029353764,
           0.4255628305091844,
           0.5744371694908157,
           0.7166976970646236,
           0.8397047841495122,
           0.9325316833444921,
           0.9869532642585856};
      w = {0.03333567215434423,
           0.07472567457529,
           0.1095431812579912,
           0.134633359654998,
           0.1477621123573761,
           0.1477621123573765,
           0.1346333596549973,
           0.109543181257991,
           0.07472567457529056,
           0.03333567215434426};
      break;
    case 12:
      x = {0.009219682876640378,
           0.04794137181476255,
           0.1150486629028475,
           0.2063410228566914,
           0.3160842505009099,
           0.4373832957442654,
           0.5626167042557346,
           0.68391574949909,
           0.7936589771433087,
           0.8849513370971525,
           0.9520586281852376,
           0.9907803171233598};
      w = {0.02358766819325601,
           0.05346966299765912,
           0.08003916427167318,
           0.101583713361533,
           0.1167462682691775,
           0.1245735229067015,
           0.1245735229067015,
           0.1167462682691773,
           0.101583713361533,
           0.08003916427167339,
           0.05346966299765927,
           0.02358766819325585};
      break;
    case 16:
      x = {0.005299532504174975,
           0.02771248846338353,
           0.06718439880608396,
           0.1222977958224984,
           0.1910618777986781,
           0.2709916111713863,
           0.3591982246103707,
           0.4524937450811815,
           0.5475062549188188,
           0.6408017753896296,
           0.7290083888286136,
           0.808938122201322,
           0.8777022041775016,
           0.9328156011939159,
           0.9722875115366161,
           0.994700467495825};
      w = {0.01357622970587707,
           0.03112676196932375,
           0.04757925584124661,
           0.06231448562776682,
           0.07479799440828847,
           0.08457825969750156,
           0.09130170752246193,
           0.09472530522753399,
           0.09472530522753478,
           0.09130170752246126,
           0.08457825969750159,
           0.0747979944082882,
           0.06231448562776774,
           0.04757925584124636,
           0.03112676196932393,
           0.01357622970587707};
      break;
    case 20:
      x = {0.003435700407452502, 0.01801403636104321, 0.04388278587433714, 0.08044151408889055,
           0.1268340467699246,   0.1819731596367425,  0.2445664990245865,  0.3131469556422902,
           0.3861070744291775,   0.4617367394332513,  0.5382632605667487,  0.6138929255708228,
           0.6868530443577098,   0.7554335009754136,  0.8180268403632576,  0.8731659532300755,
           0.9195584859111094,   0.9561172141256626,  0.9819859636389568,  0.9965642995925473};
      w = {0.008807003569576043, 0.0203007149001937,  0.03133602416705427, 0.04163837078835239,
           0.0509650599086201,   0.05909726598075941, 0.06584431922458812, 0.0710480546591913,
           0.07458649323630168,  0.0763766935653629,  0.07637669356536299, 0.07458649323630215,
           0.07104805465919138,  0.06584431922458857, 0.05909726598075964, 0.05096505990861998,
           0.04163837078835197,  0.03133602416705467, 0.02030071490019304, 0.008807003569576187};
      break;
    case 30:
      x = {0.001553257962675192, 0.008165938360126357, 0.01998906751584634, 0.03689997628536273,
           0.05871973210397358,  0.08521711880861577,  0.1161112839475868,  0.1510747526033421,
           0.1897369085053784,   0.23168792592899,     0.2764831152309553,  0.3236476372345609,
           0.372681536916055,    0.4230650431957081,   0.474264078722341,   0.5257359212776591,
           0.5769349568042921,   0.627318463083945,    0.6763523627654391,  0.7235168847690446,
           0.7683120740710101,   0.8102630914946214,   0.8489252473966579,  0.8838887160524131,
           0.9147828811913843,   0.9412802678960264,   0.963100023714637,   0.9800109324841538,
           0.9918340616398736,   0.9984467420373246};
      w = {0.003984096248083338, 0.009233234155545484, 0.01439235394166194, 0.01939959628481315,
           0.02420133641529709,  0.0287465781088094,   0.03298711494109029, 0.03687798736885261,
           0.04037794761471006,  0.04344989360054158,  0.04606126111889319, 0.04818436858732199,
           0.04979671029339737,  0.05088119487420244,  0.05142632644677967, 0.05142632644677915,
           0.05088119487420278,  0.04979671029339732,  0.0481843685873224,  0.04606126111889252,
           0.04344989360054204,  0.0403779476147104,   0.03687798736885246, 0.0329871149410903,
           0.02874657810880945,  0.02420133641529774,  0.01939959628481316, 0.01439235394166161,
           0.009233234155545658, 0.003984096248083273};
      break;
    case 40:
      x = {0.0008811451447204299, 0.004636880650271624, 0.01137002500811307, 0.02104159039310433,
           0.03359359586066191,   0.04895059651556288,  0.06702024839387016, 0.08769388458334409,
           0.1108471742867403,    0.1363408724050365,   0.1640216576929103,  0.1937230551660097,
           0.2252664374524357,    0.2584620991569107,   0.2931103978141975,  0.3290029545871207,
           0.3659239074963729,    0.4036512096493143,   0.4419579646623724,  0.4806137912469748,
           0.5193862087530253,    0.5580420353376276,   0.5963487903506857,  0.6340760925036268,
           0.6709970454128792,    0.7068896021858027,   0.7415379008430895,  0.774733562547564,
           0.80627694483399,      0.8359783423070898,   0.8636591275949634,  0.8891528257132597,
           0.9123061154166558,    0.9329797516061296,   0.9510494034844372,  0.9664064041393384,
           0.978958409606896,     0.9886299749918872,   0.9953631193497287,  0.9991188548552798};
      w = {0.002260638549266528, 0.005249142265576765, 0.008210529190954059, 0.01112292459708328,
           0.01396850349001133,  0.01673009764127386,  0.01939108398723628,  0.02193545409283664,
           0.02434790381753616,  0.02661392349196839,  0.02871988454969542,  0.03065312124646457,
           0.03240200672830051,  0.03395602290761735,  0.03530582369564322,  0.03644329119790184,
           0.03736158452898407,  0.03805518095031343,  0.03851990908212326,  0.03875297398921271,
           0.03875297398921225,  0.03851990908212417,  0.0380551809503133,   0.03736158452898412,
           0.03644329119790179,  0.03530582369564304,  0.03395602290761734,  0.0324020067283003,
           0.0306531212464645,   0.02871988454969549,  0.02661392349196847,  0.02434790381753585,
           0.02193545409283717,  0.01939108398723586,  0.01673009764127338,  0.01396850349001175,
           0.01112292459708374,  0.008210529190954169, 0.005249142265576059, 0.002260638549266752};
      break;
    case 80:
      x = {0.000223088674184635, 0.001175067800881335, 0.002886229517155892, 0.005354348750122362,
           0.008575713630685655, 0.01254542970713612,  0.01725745547810054,  0.0227046168281827,
           0.02887861934506397,  0.03577006141377725,  0.04336844871412099,  0.05166221028061474,
           0.06063871616089328,  0.07028429666844438,  0.08058426320987233,  0.0915229306592682,
           0.1030836412476974,   0.115248789932479,    0.1279998512082015,   0.1413174073189502,
           0.1551811778289863,   0.16957005050694,     0.1844621134765639,   0.199834688585124,
           0.2156643659386451,   0.2319270395514338,   0.2485979440556073,   0.2656516924147276,
           0.2830623145841219,   0.3008032970590154,   0.3188476232502564,   0.3371678146261489,
           0.3557359725577439,   0.374523820803864,    0.3935027485711671,   0.412643854083677,
           0.431917988595428,    0.4512958007792078,   0.4707477814237899,   0.4902443083716032,
           0.5097556916283972,   0.5292522185762104,   0.5487041992207923,   0.568082011404572,
           0.5873561459163236,   0.6064972514288333,   0.6254761791961362,   0.644264027442256,
           0.6628321853738509,   0.6811523767497436,   0.6991967029409848,   0.716937685415878,
           0.7343483075852724,   0.7514020559443926,   0.7680729604485659,   0.7843356340613548,
           0.8001653114148759,   0.815537886523436,    0.8304299494930596,   0.8448188221710137,
           0.85868259268105,     0.8720001487917985,   0.8847512100675206,   0.8969163587523026,
           0.9084770693407318,   0.9194157367901274,   0.9297157033315555,   0.9393612838391068,
           0.9483377897193852,   0.9566315512858787,   0.9642299385862227,   0.9711213806549364,
           0.9772953831718172,   0.9827425445218994,   0.9874545702928637,   0.9914242863693143,
           0.9946456512498776,   0.9971137704828441,   0.9988249321991187,   0.9997769113258153};
      w = {
          0.0005724750015935829, 0.001331766794756083, 0.00209015656234747,  0.002845461225701455,
          0.003596452384058864,  0.004341972634630063, 0.005080883020551938, 0.005812057060399283,
          0.006534380796200345,  0.007246754020254332, 0.00794809179186279,  0.008637326028134728,
          0.009313407104149343,  0.009975305439070716, 0.01062201305789127,  0.01125254512316596,
          0.01186594143296515,   0.01246126788205799,  0.01303761788378269,  0.01359411375024307,
          0.01412990802863836,   0.01464418479163394,  0.01513616087977912,  0.01560508709405745,
          0.01605024933674352,   0.01647096969882277,  0.01686660749230598,  0.01723656022587697,
          0.01758026452237389,   0.0178971969767078,   0.01818687495291785,  0.01844885731913827,
          0.01868274511936515,   0.018888182181001,    0.01906485565723848,  0.01921249650347986,
          0.01933087988703829,   0.01941982552952643,  0.01947919798138537,  0.01950890682815304,
          0.01950890682815289,   0.01947919798138433,  0.01941982552952594,  0.01933087988703873,
          0.01921249650347963,   0.01906485565723888,  0.01888818218100091,  0.01868274511936495,
          0.0184488573191383,    0.01818687495291781,  0.01789719697670791,  0.01758026452237373,
          0.01723656022587688,   0.01686660749230561,  0.01647096969882261,  0.01605024933674383,
          0.01560508709405768,   0.01513616087977928,  0.01464418479163459,  0.01412990802863829,
          0.0135941137502433,    0.01303761788378273,  0.01246126788205774,  0.0118659414329652,
          0.01125254512316672,   0.01062201305789101,  0.009975305439071061, 0.009313407104150202,
          0.008637326028134436,  0.007948091791862205, 0.007246754020254351, 0.006534380796200811,
          0.005812057060399114,  0.0050808830205515,   0.004341972634630382, 0.003596452384058713,
          0.00284546122570141,   0.002090156562346913, 0.001331766794756246, 0.0005724750015935458};
      break;
    case 200:
      x = {
          3.5964357465057e-05,  0.0001894843595316997, 0.0004656390634237284, 0.0008644220255445423,
          0.001385742858309946, 0.002029475369494216,  0.002795462117149317,  0.003683515291404982,
          0.004693416984663079, 0.005824919319619315,  0.007077744539106756,  0.00845158508695204,
          0.009946103689537855, 0.01156093344171705,   0.01329567789858499,   0.01514991117378167,
          0.01712317804462782,  0.01921499406424482,   0.02142484568071723,   0.02375219036332271,
          0.02619645673582899,  0.0287570447168386,    0.03143332566716089,   0.03422464254418162,
          0.03713031006319617,  0.0401496148656687,    0.04328181569437978,   0.04652614357542062,
          0.0498818020069885,   0.05334796715493673,   0.05692378805503834,   0.06060838682190589,
          0.06440085886451835,  0.06830027310830861,   0.07230567222374851,   0.07641607286138052,
          0.08063046589323758,  0.08494781666059065,   0.08936706522796428,   0.09388712664335841,
          0.09850689120461087,  0.1032252247318361,    0.1080409688458743,    0.112952941252679,
          0.1179599360335803,   0.1230607239413433,    0.1282540527019565,    0.1335386473220729,
          0.1389132104020281,   0.1443764224543611,    0.1499269422277551,    0.1555634070363229,
          0.161284433094157,    0.1670886158550527,    0.1729745303573371,    0.1789407315737048,
          0.1849857547659781,   0.191108115844712,     0.1973063117335476,    0.2035788207382228,
          0.2099241029201608,   0.2163406004745332,    0.2228267381127095,    0.2293809234490013,
          0.236001547391602,    0.2426869845376282,    0.2494355935721665,    0.2562457176712257,
          0.2631156849084962,   0.2700438086658234,    0.2770283880472709,    0.2840677082967137,
          0.2911600412188127,   0.2983036456032996,    0.3054967676524565,    0.3127376414116798,
          0.3200244892030347,   0.3273555220616868,    0.3347289401751018,    0.3421429333249114,
          0.3495956813313329,   0.3570853545000323,    0.3646101140713286,    0.3721681126716179,
          0.3797574947669143,   0.3873763971183971,    0.3950229492398449,    0.4026952738568517,
          0.4103914873677097,   0.4181097003058446,    0.4258480178036894,    0.4336045400578885,
          0.4413773627957088,   0.4491645777425507,    0.456964273090442,     0.4647745339673951,
          0.4725934429075237,   0.4804190803217888,    0.4882495249692711,    0.4960828544288466,
          0.5039171455711532,   0.5117504750307287,    0.5195809196782111,    0.527406557092476,
          0.5352254660326043,   0.5430357269095578,    0.5508354222574486,    0.5586226372042911,
          0.5663954599421114,   0.5741519821963106,    0.5818902996941556,    0.5896085126322897,
          0.5973047261431478,   0.6049770507601547,    0.6126236028816023,    0.6202425052330853,
          0.6278318873283821,   0.6353898859286713,    0.6429146454999678,    0.6504043186686675,
          0.6578570666750887,   0.6652710598248982,    0.6726444779383132,    0.6799755107969651,
          0.6872623585883204,   0.6945032323475433,    0.7016963543966999,    0.7088399587811873,
          0.7159322917032862,   0.722971611952729,     0.7299561913341768,    0.736884315091503,
          0.7437542823287744,   0.7505644064278338,    0.7573130154623722,    0.763998452608398,
          0.7706190765509988,   0.7771732618872906,    0.7836593995254668,    0.7900758970798389,
          0.7964211792617771,   0.8026936882664526,    0.8088918841552878,    0.8150142452340222,
          0.8210592684262956,   0.8270254696426628,    0.8329113841449474,    0.8387155669058433,
          0.8444365929636768,   0.8500730577722451,    0.8556235775456391,    0.8610867895979719,
          0.8664613526779275,   0.8717459472980437,    0.8769392760586565,    0.8820400639664195,
          0.8870470587473209,   0.8919590311541259,    0.8967747752681641,    0.9014931087953891,
          0.9061128733566418,   0.9106329347720359,    0.9150521833394096,    0.9193695341067627,
          0.9235839271386197,   0.9276943277762518,    0.9316997268916918,    0.9355991411354818,
          0.9393916131780942,   0.9430762119449614,    0.9466520328450634,    0.9501181979930117,
          0.9534738564245794,   0.9567181843056207,    0.9598503851343319,    0.9628696899368041,
          0.9657753574558186,   0.9685666743328395,    0.9712429552831616,    0.9738035432641712,
          0.9762478096366776,   0.9785751543192833,    0.9807850059357555,    0.9828768219553724,
          0.9848500888262188,   0.9867043221014156,    0.9884390665582832,    0.9900538963104621,
          0.991548414913048,    0.9929222554608932,    0.9941750806803806,    0.9953065830153369,
          0.9963164847085949,   0.9972045378828509,    0.9979705246305057,    0.9986142571416898,
          0.9991355779744554,   0.9995343609365761,    0.9998105156404682,    0.9999640356425352};
      w = {9.229504873584985e-05, 0.0002148233152253478, 0.000337480317239408,
           0.0004600702296712821, 0.0005825503573777825, 0.0007048884137269863,
           0.0008270537761566921, 0.0009490162524693522, 0.001070745819720108,
           0.001192212556002391,  0.001313386622258159,  0.001434238259734318,
           0.001554737793051476,  0.001674855635517603,  0.00179456229540629,
           0.001913828382672534,  0.00203262461588739,   0.002150921829256565,
           0.002268690979679756,  0.002385903153820268,  0.002502529575169602,
           0.002618541611078469,  0.002733910779775182,  0.002848608757344535,
           0.002962607384675787,  0.003075878674365886,  0.003188394817591402,
           0.003300128190930785,  0.003411051363141983,  0.003521137101900877,
           0.003630358380479411,  0.003738688384383568,  0.003846100517936835,
           0.003952568410805129,  0.004058065924474594,  0.004162567158665574,
           0.004266046457693802,  0.00436847841676277,   0.004469837888211146,
           0.004570099987675964,  0.00466924010020744,   0.004767233886309951,
           0.004864057287920066,  0.004959686534309662,  0.005054098147923814,
           0.005147268950142769,  0.005239176066975266,  0.005329796934670928,
           0.005419109305263319,  0.005507091252028186,  0.005593721174869141,
           0.005678977805620078,  0.005762840213266269,  0.005845287809082791,
           0.005926300351689566,  0.006005857952021953,  0.006083941078211342,
           0.006160530560380212,  0.006235607595353423,  0.006309153751267087,
           0.006381150972096681,  0.006451581582095985,  0.006520428290126014,
           0.006587674193905699,  0.006653302784164315,  0.006717297948686756,
           0.00677964397627807,   0.006840325560614128,  0.006899327804001443,
           0.006956636221035364,  0.00701223674215604,   0.007066115717101092,
           0.007118259918260463,  0.007168656543918306,  0.007217293221401462,
           0.007264158010114936,  0.007309239404469535,  0.00735252633671367,
           0.007394008179647118,  0.007433674749227226,  0.007471516307073039,
           0.007507523562855361,  0.007541687676577837,  0.007574000260744188,
           0.007604453382421627,  0.007633039565186618,  0.007659751790959058,
           0.007684583501728193,  0.007707528601160204,  0.007728581456094411,
           0.007747736897929327,  0.007764990223888356,  0.007780337198176993,
           0.00779377405302219,   0.007805297489593164,  0.007814904678819009,
           0.007822593262076506,  0.007828361351771701,  0.007832207531805377,
           0.007834130857915999,  0.007834130857916009,  0.007832207531805585,
           0.007828361351772405,  0.007822593262076492,  0.007814904678820022,
           0.007805297489593507,  0.007793774053022181,  0.007780337198177696,
           0.007764990223888181,  0.007747736897929041,  0.00772858145609449,
           0.007707528601160051,  0.007684583501727869,  0.007659751790959727,
           0.007633039565186349,  0.007604453382421762,  0.007574000260743724,
           0.00754168767657653,   0.007507523562855794,  0.007471516307072428,
           0.007433674749227071,  0.007394008179647186,  0.007352526336714298,
           0.007309239404469582,  0.0072641580101141,    0.007217293221402119,
           0.007168656543918532,  0.007118259918260358,  0.00706611571710125,
           0.0070122367421562,    0.00695663622103568,   0.006899327804001667,
           0.006840325560614126,  0.006779643976277895,  0.006717297948686965,
           0.006653302784164128,  0.00658767419390586,   0.006520428290125645,
           0.006451581582096186,  0.006381150972096921,  0.0063091537512662,
           0.00623560759535319,   0.006160530560380712,  0.006083941078211205,
           0.006005857952022147,  0.005926300351689471,  0.005845287809082382,
           0.00576284021326656,   0.00567897780562006,   0.005593721174868762,
           0.005507091252028263,  0.005419109305263074,  0.005329796934671047,
           0.00523917606697564,   0.00514726895014325,   0.00505409814792369,
           0.004959686534309095,  0.004864057287920338,  0.004767233886310146,
           0.00466924010020757,   0.00457009998767569,   0.004469837888211489,
           0.004368478416763171,  0.004266046457692925,  0.004162567158665393,
           0.004058065924474268,  0.003952568410804706,  0.003846100517936504,
           0.003738688384383724,  0.00363035838047838,   0.003521137101901117,
           0.003411051363142785,  0.003300128190930307,  0.003188394817591546,
           0.003075878674366077,  0.002962607384675911,  0.002848608757344138,
           0.002733910779775525,  0.002618541611078311,  0.002502529575169577,
           0.002385903153820551,  0.002268690979679305,  0.00215092182925634,
           0.002032624615887844,  0.001913828382672675,  0.001794562295405616,
           0.001674855635518267,  0.001554737793051348,  0.001434238259734413,
           0.001313386622258311,  0.001192212556002759,  0.001070745819719768,
           0.0009490162524696159, 0.0008270537761568535, 0.0007048884137273808,
           0.0005825503573776667, 0.0004600702296706742, 0.0003374803172395162,
           0.0002148233152254676, 9.229504873548172e-05};
      break;
    default:
      ::mooseError("Gauss-Legendre order ", order, " is not supported");
  }
}

DenseMatrix<Real>
aqRoationMatrix(const Point & normal, const unsigned int dim)
{
  DenseMatrix<Real> rot(3, 3);
  if (dim == 2)
  {
    rot(0, 0) = normal(0);
    rot(0, 1) = -normal(1);
    rot(1, 0) = normal(1);
    rot(1, 1) = normal(0);
    rot(2, 2) = 1;
  }
  else if (dim == 3)
  {
    // Create a local coordinate system around normal
    Point tx(HCAngularQuadrature::getOrthonormalVector(normal, dim));
    Point ty = normal.cross(tx);

    // Create rotation matrix and rotate vector omega
    for (unsigned int j = 0; j < 3; ++j)
    {
      rot(j, 0) = tx(j);
      rot(j, 1) = ty(j);
      rot(j, 2) = normal(j);
    }
  }
  else
    ::mooseError("Dimension ", dim, " not supported in aqRoationMatrix()");
  return rot;
}

void
getHalfRangeAQ3D(unsigned int cheb_order,
                 unsigned int leg_order,
                 std::vector<std::pair<Real, Real>> & x,
                 std::vector<Real> & w)
{
  std::vector<Real> cheb_x(cheb_order);
  std::vector<Real> cheb_w(cheb_order);

  for (unsigned int j = 0; j < cheb_order; ++j)
  {
    unsigned int k = j + 1;
    cheb_x[j] = (2 * k - 1) * M_PI / cheb_order;
    cheb_w[j] = 2 * M_PI / cheb_order;
  }

  // Legendre quadrature
  std::vector<Real> gleg_hr_x;
  std::vector<Real> gleg_hr_w;

  getLegHRQ(leg_order, gleg_hr_x, gleg_hr_w);

  // product quadrature
  unsigned int prod_order = cheb_order * leg_order;
  x.resize(prod_order);
  w.resize(prod_order);

  unsigned int l = 0;
  for (unsigned int i = 0; i < cheb_order; ++i)
    for (unsigned int j = 0; j < leg_order; ++j)
    {
      x[l].first = cheb_x[i];
      x[l].second = gleg_hr_x[j];
      w[l] = gleg_hr_w[j] * cheb_w[i];
      ++l;
    }
}

void
getHalfRangeAQ2D(unsigned int leg_order,
                 std::vector<std::pair<Real, Real>> & x,
                 std::vector<Real> & w)
{
  // Legendre quadrature
  std::vector<Real> gleg_hr_x;
  std::vector<Real> gleg_hr_w;

  getLegHRQ(leg_order, gleg_hr_x, gleg_hr_w);
  x.resize(2 * gleg_hr_w.size());
  w.resize(2 * gleg_hr_w.size());

  unsigned int l = 0;
  for (unsigned int j = 0; j < gleg_hr_w.size(); ++j)
  {
    x[l].first = 1;
    x[l].second = gleg_hr_x[j] * M_PI / 2;
    w[l] = gleg_hr_w[j] * M_PI / 2;
    ++l;
    x[l].first = -1;
    x[l].second = -gleg_hr_x[j] * M_PI / 2;
    w[l] = gleg_hr_w[j] * M_PI / 2;
    ++l;
  }
}

Point
getOrthonormalVector(const Point & v, unsigned int dim)
{
  if (MooseUtils::absoluteFuzzyLessEqual(v.norm(), 0))
    ::mooseError("Vector v has norm close to 0");
  if (dim != 2 && dim != 3)
    ::mooseError("Dimension must be 2 or 3 but is provided as ", dim);

  if (v(0) == 0)
    return Point(1, 0, 0);
  else if (v(1) == 0)
    return Point(0, 1, 0);
  else if (v(2) == 0 && dim == 3)
    return Point(0, 0, 1);

  Point t(-v(1), v(0), 0);
  return t / t.norm();
}

Point
getAngularDirection(const unsigned int l,
                    const DenseMatrix<Real> & rotation_matrix,
                    const std::vector<std::pair<Real, Real>> & angles,
                    const unsigned int dim)
{
  Point direction;
  DenseVector<Real> omega(3);
  DenseVector<Real> omega_p(3);
  Real phi = angles[l].first;
  Real x = angles[l].second;
  // the main difference between 2D and 3D is that 2D is formulated
  // in terms of angle theta (called x here)
  if (dim == 2)
  {
    omega(0) = std::cos(x);
    omega(1) = std::sin(x);
  }
  else if (dim == 3)
  {
    omega(0) = sqrt(1 - x * x) * cos(phi);
    omega(1) = sqrt(1 - x * x) * sin(phi);
    omega(2) = x;
  }
  rotation_matrix.vector_mult(omega_p, omega);
  direction = Point(omega_p(0), omega_p(1), omega_p(2));
  return direction;
}

}
